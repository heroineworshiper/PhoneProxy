#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdint.h>


// gcc -o test test.c;./test

typedef unsigned short u16;

static int chksum(int sum, unsigned char *data, int size)
{
	unsigned char *ptr = data;
	unsigned char *end = data + size - 1;
	int t;

	while(ptr < end)
	{
		t = (ptr[0] << 8) | ptr[1];
		sum += t;
        sum &= 0xffff;
		if(sum < t) sum++; // add 1 if carry
printf("t=%d sum=%d\n", t, sum);
		ptr += 2;
	}

	if(ptr == end)
	{
		t = ((int)ptr[0]) << 8;
		sum += t;
        sum &= 0xffff;
		if(sum < t) sum++; // add 1 if carry
printf("t=%d sum=%d\n", t, sum);
	}

	return sum;
}


void main()
{

    uint8_t packet[] = {
0x45, 0x00, 0x00, 0x9b, 0xc7, 0x30, 0x00, 0x00, 0x3f, 0x11, 0x13, 0x7f, 0x4b, 0x4b, 0x4b, 0x4b,
0x0a, 0x0c, 0x00, 0x01, 0x00, 0x35, 0xa8, 0x52, 0x00, 0x87, 0x84, 0xcf, 0x44, 0xe1, 0x81, 0x83,
0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x20, 0x61, 0x62, 0x66, 0x61, 0x73, 0x64, 0x6a,
0x66, 0x68, 0x61, 0x73, 0x6b, 0x64, 0x6c, 0x66, 0x6a, 0x68, 0x61, 0x73, 0x6c, 0x6b, 0x66, 0x6a,
0x61, 0x68, 0x73, 0x64, 0x6c, 0x6b, 0x66, 0x61, 0x73, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x01,
0x00, 0x01, 0xc0, 0x32, 0x00, 0x06, 0x00, 0x01, 0x00, 0x00, 0x03, 0x84, 0x00, 0x3d, 0x01, 0x61,
0x0c, 0x67, 0x74, 0x6c, 0x64, 0x2d, 0x73, 0x65, 0x72, 0x76, 0x65, 0x72, 0x73, 0x03, 0x6e, 0x65,
0x74, 0x00, 0x05, 0x6e, 0x73, 0x74, 0x6c, 0x64, 0x0c, 0x76, 0x65, 0x72, 0x69, 0x73, 0x69, 0x67,
0x6e, 0x2d, 0x67, 0x72, 0x73, 0xc0, 0x32, 0x52, 0x0e, 0x5a, 0x60, 0x00, 0x00, 0x07, 0x08, 0x00,
0x00, 0x03, 0x84, 0x00, 0x09, 0x3a, 0x80, 0x00, 0x00, 0x03, 0x84
    };


// zero the UDP chksum
    packet[26] = 0;
    packet[27] = 0;

    int total_length = sizeof(packet);
    int udp_length = total_length - 20;
    uint8_t pseudo_hdr[12];
    memcpy(pseudo_hdr + 0, packet + 12, 4); // src address
    memcpy(pseudo_hdr + 4, packet + 16, 4); // dst address
    pseudo_hdr[8] = 0;
    pseudo_hdr[9] = 0x11; // protocol UDP
    pseudo_hdr[10] = udp_length >> 8;
    pseudo_hdr[11] = udp_length & 0xff;

    uint8_t packet2[sizeof(pseudo_hdr) + udp_length];
    memcpy(packet2, pseudo_hdr, sizeof(pseudo_hdr));
    memcpy(packet2 + sizeof(pseudo_hdr), packet + 20, udp_length);

//    uint16_t sum = chksum(0, pseudo_hdr, sizeof(pseudo_hdr));
    uint16_t sum = chksum(sum, packet2, sizeof(packet2));
    if(sum == 0) sum = 0xffff;
    sum = ~sum;


    printf("chksum=%04x\n", sum);
}
